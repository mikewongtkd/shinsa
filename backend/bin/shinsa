#! /usr/bin/perl

use lib qw( /usr/local/shinsa/lib );
use Mojolicious::Lite;
use Try::Tiny;
use Shinsa;
use Shinsa::RequestManager;
use Shinsa::Client::Registry;
use JSON::XS;
use Clone qw( clone );

our $json     = new JSON::XS();
our $registry = new Shinsa::Client::Registry();
our $manager  = new Shinsa::RequestManager();

websocket '/shinsa/api/v1/:uuid' => sub {
	my $self   = shift;
	my $client = $registry->add( $self );

	$self->inactivity_timeout( 3600 ); # 1 hour
	$client->ping->start();

	my $request = { type => 'user', action => 'connect', user => { sessid => $client->sessid(), id => $client->id(), role => $client->role() }};
	$registry->remove( $client );
	$manager->broadcast_user_update( $request, $client->group());

	# ----------------------------------------
	$self->on( message => sub {
	# ----------------------------------------
		try { $manager->handle( $request, $client->group()); }
		catch { $client->send({ json => { error => "Error while processing request: $_\n", request => $request }}); }
	});

	# ----------------------------------------
	$self->on( finish => sub {
	# ----------------------------------------
		my $request = { type => 'user', action => 'disconnect', user => { sessid => $client->sessid(), id => $client->id(), role => $client->role() }};
		$registry->remove( $client );
		$manager->broadcast_user_update( $request, $client->group());
		$client->ping->quit();
	});
}
